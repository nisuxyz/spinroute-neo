# Project Structure

## Monorepo Organization

SpinRoute Neo uses a Bun workspace monorepo with the following top-level structure:

```
spinroute-neo/
├── backend/              # API Gateway (Hono + Better Auth)
├── frontend/             # Web frontend (Astro)
├── frontend-expo/        # Mobile app (React Native + Expo)
├── services/             # Microservices
├── shared/               # Shared utilities workspace package
└── docs/                 # Documentation
```

## Backend (API Gateway)

```
backend/
├── lib/
│   ├── auth.ts              # Better Auth configuration
│   ├── auth-middleware.ts   # Authentication middleware
│   ├── config.ts            # Environment configuration
│   ├── drizzle.ts           # Drizzle ORM setup
│   ├── service-middleware.ts # Service communication middleware
│   └── db/
│       ├── auth-schema.ts   # Auth database schema
│       ├── schema.ts        # Application schema
│       └── seed.ts          # Database seeding
├── src/
│   ├── index.ts             # Main application entry
│   ├── health.ts            # Health check endpoints
│   └── feature/
│       └── internal/
│           └── +routes.internal.ts  # Auto-loaded internal routes
├── drizzle/                 # Generated migrations
├── Containerfile            # Production container
├── Containerfile.dev        # Development container
└── compose.yaml             # Podman compose config
```

## Services Architecture

Each service follows a consistent structure pattern:

```
services/<service-name>/
├── lib/
│   ├── auth.ts              # Supabase Auth middleware
│   ├── config.ts
│   ├── db.ts                # Supabase client
│   ├── db.types.ts          # Generated Supabase types
│   └── service-middleware.ts
├── src/
│   ├── index.ts             # Service entry point
│   ├── health.ts            # Health checks
│   └── feature/
│       ├── +routes.api.ts   # Public API routes
│       └── internal/
│           └── +routes.internal.ts  # Internal routes
├── supabase/
│   └── migrations/          # Supabase SQL migrations
├── Containerfile
├── Containerfile.dev
└── compose.yaml
```

### Available Services

- **bikeshare**: Bikeshare station data and availability
- **gbfs**: Go-based real-time GBFS data consumer (WebSocket)
- **recording**: Ride/trip recording and activity tracking (Strava-like)
- **safety**: Live location sharing, crash detection, and emergency alerts
- **routing**: Route calculation
- **service-template**: Template for creating new services

Note: Vehicle/bike management is handled directly in the frontend via Supabase RLS policies on the `vehicles` schema.

## Frontend Expo (Mobile)

```
frontend-expo/
├── app/
│   ├── (tabs)/              # Tab-based navigation
│   │   ├── _layout.tsx      # Tab layout
│   │   ├── index.tsx        # Home/Map screen
│   │   └── explore.tsx      # Explore screen
│   ├── _layout.tsx          # Root layout
│   └── modal.tsx            # Modal screens
├── components/
│   ├── MainMapView.tsx      # Main map component
│   ├── StationCallout.tsx   # Station info callout
│   ├── StationToggleButton.tsx
│   └── ui/                  # Reusable UI components
├── hooks/
│   ├── use-bikeshare-stations.ts
│   ├── use-supabase.ts
│   └── use-theme-color.ts
├── utils/
│   └── supabase.ts          # Supabase client setup
├── constants/
│   └── theme.ts             # Theme configuration
├── assets/
│   └── images/              # App icons and images
└── supabase/
    ├── types.ts             # Generated types
    └── migrations/          # Local migrations
```

## Shared Package

```
shared/
├── index.ts                 # Main exports
├── drizzle-geography.ts     # PostGIS/geography helpers
├── supabase-hono.ts         # Supabase middleware for Hono
└── package.json
```

## Routing Convention

Services use a **SvelteKit-inspired file-based routing** with `+` prefix:

- `+routes.api.ts`: Public API routes (exposed externally)
- `+routes.internal.ts`: Internal service-to-service routes
- Routes are auto-discovered and registered via Bun's Glob API
- Each route file exports `router` (Hono instance) and `basePath` (string)

Example:
```typescript
// src/feature/+routes.api.ts
import { Hono } from 'hono';

export const basePath = '/api/feature';
export const router = new Hono();

router.get('/endpoint', (c) => c.json({ data: 'value' }));
```

## Configuration Files

- `.env.example`: Environment variable templates (per service)
- `drizzle.config.ts`: Drizzle Kit configuration
- `tsconfig.json`: TypeScript configuration
- `compose.yaml`: Podman Compose service definitions
- `kustomization.yaml`: Kubernetes deployment configs (some services)

## Database Migrations

- **Drizzle**: Used for backend/API gateway only (`drizzle/` folder)
- **Supabase**: Used for all microservices (`supabase/migrations/` folder)
- Migration files are timestamped SQL
- Drizzle migrations generated by Drizzle Kit
- Supabase migrations created via Supabase CLI or MCP tools

## Development Workflow

1. Services run independently on different ports
2. API Gateway routes requests to appropriate services
3. Shared utilities imported via workspace protocol: `shared-utils: workspace:*`
4. Each service has its own database schema/namespace in Supabase
5. Container-based development with hot reload support
